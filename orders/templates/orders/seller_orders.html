{% extends 'base.html' %}

{% block title %}–ó–∞–∫–∞–∑—ã –Ω–∞ –º–æ–∏ —Ç–æ–≤–∞—Ä—ã - Fruitsite{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">–ó–∞–∫–∞–∑—ã –Ω–∞ –º–æ–∏ —Ç–æ–≤–∞—Ä—ã</h1>
        <p class="text-gray-600">–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–∏–¥–µ—Ç—å –≤—Å–µ –∑–∞–∫–∞–∑—ã, —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ –≤–∞—à–∏ —Ç–æ–≤–∞—Ä—ã</p>
    </div>

    {% if orders_data %}
        <div class="space-y-6">
            {% for order_data in orders_data %}
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-xl font-semibold text-gray-900">–ó–∞–∫–∞–∑ #{{ order_data.order.id }}</h3>
                            <p class="text-gray-600">{{ order_data.order.created_at|date:"d.m.Y H:i" }}</p>
                        </div>
                        <div class="text-right">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium mb-3
                                {% if order_data.order.status == 'new' %}bg-blue-100 text-blue-800
                                {% elif order_data.order.status == 'accepted' %}bg-green-100 text-green-800
                                {% elif order_data.order.status == 'rejected' %}bg-red-100 text-red-800
                                {% elif order_data.order.status == 'processing' %}bg-yellow-100 text-yellow-800
                                {% elif order_data.order.status == 'shipped' %}bg-purple-100 text-purple-800
                                {% elif order_data.order.status == 'delivered' %}bg-green-100 text-green-800
                                {% elif order_data.order.status == 'canceled' %}bg-red-100 text-red-800
                                {% endif %}">
                                {{ order_data.order.get_status_display }}
                            </span>
                            
                            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –ø—Ä–æ–¥–∞–≤—Ü–∞ -->
                            {% if order_data.order.status == 'new' %}
                                <div class="flex gap-2 mt-2">
                                    <a href="{% url 'orders:accept_order' order_data.order.id %}" 
                                       class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium shadow-sm transition-colors">
                                        –ü—Ä–∏–Ω—è—Ç—å
                                    </a>
                                    <a href="{% url 'orders:reject_order' order_data.order.id %}" 
                                       class="text-white px-4 py-2 rounded-md text-sm font-medium shadow-sm transition-colors"
                                       style="background-color: #dc2626; border: 1px solid #dc2626;"
                                       onmouseover="this.style.backgroundColor='#b91c1c'; this.style.borderColor='#b91c1c';"
                                       onmouseout="this.style.backgroundColor='#dc2626'; this.style.borderColor='#dc2626';"
                                       onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–∫–ª–æ–Ω–∏—Ç—å –∑–∞–∫–∞–∑?')">
                                        –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                                    </a>
                                </div>
                            {% elif order_data.order.status == 'accepted' or order_data.order.status == 'processing' or order_data.order.status == 'shipped' %}
                                <div class="mt-2 flex gap-2">
                                    <button onclick="showStatusModal({{ order_data.order.id }})" 
                                            class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm">
                                        –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å
                                    </button>
                                    <a href="{% url 'orders:download_invoice' order_data.order.id %}" 
                                       class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm inline-flex items-center gap-1">
                                        <i class="fas fa-download text-xs"></i>
                                        –ù–∞–∫–ª–∞–¥–Ω–∞—è
                                    </a>
                                </div>
                            {% elif order_data.order.status == 'delivered' %}
                                <div class="mt-2 flex gap-2">
                                    <span class="text-green-600 text-sm font-medium">‚úì –ó–∞–∫–∞–∑ –∑–∞–≤–µ—Ä—à—ë–Ω</span>
                                    <a href="{% url 'orders:download_invoice' order_data.order.id %}" 
                                       class="bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm inline-flex items-center gap-1">
                                        <i class="fas fa-download text-xs"></i>
                                        –ù–∞–∫–ª–∞–¥–Ω–∞—è
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="border-t pt-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <h4 class="font-medium text-gray-900 mb-2">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ:</h4>
                                <p class="text-gray-600">–¢–µ–ª–µ—Ñ–æ–Ω: {{ order_data.order.phone_number }}</p>
                                {% if order_data.order.buyer.username %}
                                    <p class="text-gray-600">–ò–º—è: {{ order_data.order.buyer.username }}</p>
                                {% endif %}
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-900 mb-2">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏:</h4>
                                <p class="text-gray-600">{{ order_data.order.delivery_address }}</p>
                            </div>
                        </div>

                        <h4 class="font-medium text-gray-900 mb-3">–í–∞—à–∏ —Ç–æ–≤–∞—Ä—ã –≤ —ç—Ç–æ–º –∑–∞–∫–∞–∑–µ:</h4>
                        <div class="space-y-3">
                            {% for item in order_data.items %}
                                <div class="flex items-center justify-between bg-gray-50 p-3 rounded-lg">
                                    <div class="flex items-center space-x-4">
                                        {% if item.product.images.first %}
                                            <img src="{{ item.product.images.first.image.url }}" 
                                                 alt="{{ item.product.name }}" 
                                                 class="w-12 h-12 object-cover rounded-lg">
                                        {% else %}
                                            <div class="w-12 h-12 bg-gray-200 rounded-lg flex items-center justify-center">
                                                <span class="text-gray-400 text-xs">–ù–µ—Ç —Ñ–æ—Ç–æ</span>
                                            </div>
                                        {% endif %}
                                        <div>
                                            <h5 class="font-medium text-gray-900">{{ item.product.name }}</h5>
                                            <p class="text-sm text-gray-600">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: {{ item.quantity }} —à—Ç.</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="font-medium text-gray-900">{{ item.price }} —Å–æ–º.</p>
                                        <p class="text-sm text-gray-600">
                                            –ò—Ç–æ–≥–æ: {{ item.price|floatformat:0 }} √ó {{ item.quantity }} = 
                                            {% widthratio item.price 1 item.quantity %} —Å–æ–º.
                                        </p>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>

                        {% if order_data.order.tracking_number %}
                            <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                                <p class="text-sm text-blue-800">
                                    <strong>–ù–æ–º–µ—Ä –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:</strong> {{ order_data.order.tracking_number }}
                                </p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="text-center py-12">
            <div class="text-gray-400 text-6xl mb-4">üì¶</div>
            <h3 class="text-xl font-medium text-gray-900 mb-2">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤</h3>
            <p class="text-gray-600 mb-6">–ó–∞–∫–∞–∑—ã –Ω–∞ –≤–∞—à–∏ —Ç–æ–≤–∞—Ä—ã –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å</p>
            <a href="{% url 'accounts:my_products' %}" 
               class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                –ü–µ—Ä–µ–π—Ç–∏ –∫ –º–æ–∏–º —Ç–æ–≤–∞—Ä–∞–º
            </a>
        </div>
    {% endif %}
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞ -->
<div id="statusModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <h3 class="text-lg font-medium text-gray-900 mb-4">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞</h3>
            <form id="statusForm" method="post">
                {% csrf_token %}
                <div class="mb-4">
                    <label for="status" class="block text-sm font-medium text-gray-700 mb-2">–ù–æ–≤—ã–π —Å—Ç–∞—Ç—É—Å:</label>
                    <select name="status" id="status" class="w-full border border-gray-300 rounded-md px-3 py-2">
                        <!-- –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ JavaScript -->
                    </select>
                </div>
                <div class="mb-4">
                    <label for="tracking_number" class="block text-sm font-medium text-gray-700 mb-2">–ù–æ–º–µ—Ä –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
                    <input type="text" name="tracking_number" id="tracking_number" 
                           class="w-full border border-gray-300 rounded-md px-3 py-2"
                           placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è">
                </div>
                <div class="flex justify-end gap-3">
                    <button type="button" onclick="hideStatusModal()" 
                            class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                        –û–±–Ω–æ–≤–∏—Ç—å
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function showStatusModal(orderId) {
    // –ù–∞—Ö–æ–¥–∏–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞
    const orderElement = document.querySelector(`[data-order-id="${orderId}"]`);
    let currentStatus = 'accepted'; // –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    
    // –ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ–º –Ω–∞–π—Ç–∏ —ç–ª–µ–º–µ–Ω—Ç, –∏—â–µ–º –ø–æ-–¥—Ä—É–≥–æ–º—É
    const statusSpans = document.querySelectorAll('.inline-flex.items-center');
    for (let span of statusSpans) {
        const orderDiv = span.closest('.bg-white.rounded-lg.shadow-md');
        if (orderDiv && orderDiv.textContent.includes(`–ó–∞–∫–∞–∑ #${orderId}`)) {
            const statusText = span.textContent.trim().toLowerCase();
            if (statusText.includes('–ø—Ä–∏–Ω—è—Ç')) currentStatus = 'accepted';
            else if (statusText.includes('–æ–±—Ä–∞–±–æ—Ç–∫–µ')) currentStatus = 'processing';
            else if (statusText.includes('–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω')) currentStatus = 'shipped';
            break;
        }
    }
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–ª–µ–¥—É—é—â–∏–µ —Å—Ç–∞—Ç—É—Å—ã
    const statusSelect = document.getElementById('status');
    statusSelect.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â–∏–µ –æ–ø—Ü–∏–∏
    
    const statusOptions = {
        'accepted': [
            { value: 'processing', text: '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ' },
            { value: 'shipped', text: '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω' },
            { value: 'delivered', text: '–î–æ—Å—Ç–∞–≤–ª–µ–Ω' }
        ],
        'processing': [
            { value: 'shipped', text: '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω' },
            { value: 'delivered', text: '–î–æ—Å—Ç–∞–≤–ª–µ–Ω' }
        ],
        'shipped': [
            { value: 'delivered', text: '–î–æ—Å—Ç–∞–≤–ª–µ–Ω' }
        ]
    };
    
    // –î–æ–±–∞–≤–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –æ–ø—Ü–∏–∏
    const availableOptions = statusOptions[currentStatus] || [];
    availableOptions.forEach(option => {
        const optionElement = document.createElement('option');
        optionElement.value = option.value;
        optionElement.textContent = option.text;
        statusSelect.appendChild(optionElement);
    });
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    document.getElementById('statusModal').classList.remove('hidden');
    document.getElementById('statusForm').action = '{% url "orders:update_order_status" 0 %}'.replace('0', orderId);
}

function hideStatusModal() {
    document.getElementById('statusModal').classList.add('hidden');
}

// –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
document.getElementById('statusModal').addEventListener('click', function(e) {
    if (e.target === this) {
        hideStatusModal();
    }
});
</script>
{% endblock %}
