{% extends "base.html" %}
{% load product_extras %}
{% load static %}
{% block content %}
<style>
  .mini-thumb {
    border: 2px solid #e5e7eb;
    border-radius: 0.5rem;
    cursor: pointer;
    width: 48px;
    height: 48px;
    object-fit: cover;
    margin-bottom: 8px;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .mini-thumb.active-thumb, .mini-thumb:hover {
    border-color: #2563eb;
    box-shadow: 0 0 0 2px #2563eb33;
  }
  .main-photo {
    width: 260px;
    height: 320px;
    object-fit: contain;
    border-radius: 1rem;
    background: #f3f4f6;
    box-shadow: 0 4px 24px 0 #e0e7ef;
    margin: 0 auto;
    display: block;
  }
  .size-btn {
    border: 1.5px solid #d1d5db;
    background: #fff;
    color: #222;
    border-radius: 0.5rem;
    padding: 0.3rem 1.1rem;
    font-weight: 500;
    font-size: 1rem;
    cursor: default;
    margin-right: 0.5rem;
    margin-bottom: 0.5rem;
    transition: border-color 0.2s, background 0.2s;
  }
  .size-btn.selected {
    border-color: #2563eb;
    background: #e0e7ff;
    color: #2563eb;
  }
</style>
<div class="max-w-5xl mx-auto bg-white p-6 md:p-10 rounded-2xl shadow-lg mt-6">
  <div class="flex flex-col md:flex-row gap-8">
    <!-- Галерея -->
    <div class="flex md:flex-col flex-row md:w-1/12">
      {% for img in product.images.all %}
        {% with img_url=img.get_direct_s3_url %}
        <img src="{{ img_url }}" alt="" class="mini-thumb" 
             onclick="showImage('{{ img_url }}', this)"
             onerror="this.onerror=null; this.src='{% static 'images/no-image.svg' %}'; console.log('Gallery thumb failed to load:', this.src);">
        {% endwith %}
      {% endfor %}
    </div>
    <!-- Фото товара -->
    <div class="flex-1 flex flex-col items-center justify-center">
      {% if product.images.first %}
        {% with img_url=product.images.first.get_direct_s3_url %}
        <img id="mainProductImg" src="{{ img_url }}" 
             alt="{{ product.name }}" 
             class="main-photo mb-4" 
             onerror="this.onerror=null; this.src='{% static 'images/no-image.svg' %}'; console.log('Main image failed to load:', this.src);">
        
        {% if request.user.is_staff %}
        <!-- Отладочная информация для администраторов - доступна только для персонала -->
        <div class="text-xs text-left w-full mt-2 bg-gray-50 p-2 rounded">
          <div class="mb-1">Direct URL: <a href="{{ img_url }}" target="_blank" class="text-blue-500">{{ img_url }}</a></div>
          <div>Django URL: {{ product.images.first.image.url }}</div>
          <div class="mt-1">
            <a href="{% url 'products:check_s3_images' %}" target="_blank" class="text-xs text-blue-500 hover:underline">
              Проверить изображения в S3
            </a>
          </div>
        </div>
        {% endif %}
        {% endwith %}
      {% else %}
        <div class="main-photo flex items-center justify-center text-gray-400">Нет фото</div>
      {% endif %}
    </div>
    <!-- Информация -->
    <div class="w-full md:w-1/2 flex flex-col gap-4">
      <h1 class="text-2xl font-bold text-gray-900 mb-2">{{ product.name }}</h1>
      <div class="flex items-center gap-2 mb-2">
        {% if product.old_price and product.old_price > product.price %}
          <span class="text-2xl font-bold text-gray-900">{{ product.price }} с.</span>
          <span class="text-lg text-gray-400 line-through">{{ product.old_price }} с.</span>
          <span class="text-red-600 text-base font-semibold bg-red-100 rounded px-2 py-0.5">-{{ product.discount_percent }}%</span>
        {% else %}
          <span class="text-2xl font-bold text-gray-900">{{ product.price }} с.</span>
        {% endif %}
      </div>
      <div class="flex items-center gap-2 text-sm text-gray-500 mb-2">
        <span>Категория:</span>
        {% if product.category %}
          <span class="font-medium text-gray-700">{{ product.category.name }}</span>
        {% else %}
          <span class="text-gray-400">Не указана</span>
        {% endif %}
      </div>
      <div class="flex items-center gap-2 text-sm text-gray-500 mb-2">
        <span>Продавец:</span>
        <span class="font-medium text-gray-700">{{ product.master.get_full_name|default:product.master.username|default:"Мастер" }}</span>
      </div>
      <div class="flex items-center gap-2 text-sm text-gray-500 mb-2">
        <span>В наличии:</span>
        <span class="font-medium text-gray-700">{{ product.stock }} шт.</span>
      </div>
      <div class="mb-2">
        <span class="text-sm text-gray-500">Размеры:</span>
        {% if sizes %}
          {% for size in sizes %}
            <span class="size-btn selected">{{ size }}</span>
          {% endfor %}
        {% else %}
          <span class="size-btn">Не указаны</span>
        {% endif %}
      </div>
      <div class="mb-2 text-gray-700 text-base">{{ product.description }}</div>
      <form method="post" action="{% url 'cart:add_to_cart' product.pk %}" class="mt-2">
        {% csrf_token %}
        {% if sizes %}
          <label for="size-select" class="block mb-2 text-sm text-gray-700">Выберите размер:</label>
          <select name="size" id="size-select" required class="w-full border border-gray-300 rounded px-4 py-2 mb-4">
            <option value="" disabled selected>Выберите размер</option>
            {% for size in sizes %}
              <option value="{{ size }}">{{ size }}</option>
            {% endfor %}
          </select>
        {% endif %}
        <button type="submit" class="w-full bg-blue-600 text-white text-lg font-semibold py-3 rounded-lg hover:bg-blue-700 transition">Добавить в корзину</button>
      </form>
    </div>
  </div>
</div>
<script>
// Функция для отображения выбранного изображения как основного
function showImage(imageUrl, thumbElement) {
  // Обновляем основное изображение
  const mainImg = document.getElementById('mainProductImg');
  
  // Сохраняем текущий URL на случай ошибки
  const originalSrc = mainImg.src;
  
  // Устанавливаем новый URL
  mainImg.src = imageUrl;
  
  // Обработчик ошибки загрузки изображения
  mainImg.onerror = function() {
    console.error('Failed to load image:', imageUrl);
    
    // Устанавливаем заглушку
    this.onerror = null;
    this.src = "{% static 'images/no-image.svg' %}";
  };
  
  // Удаляем класс active-thumb у всех миниатюр
  const allThumbs = document.querySelectorAll('.mini-thumb');
  allThumbs.forEach(thumb => thumb.classList.remove('active-thumb'));
  
  // Добавляем класс active-thumb для выбранной миниатюры
  thumbElement.classList.add('active-thumb');
}

// Активируем первую миниатюру по умолчанию при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
  const firstThumb = document.querySelector('.mini-thumb');
  if (firstThumb) {
    firstThumb.classList.add('active-thumb');
    
    // Проверим загрузку основного изображения
    const mainImg = document.getElementById('mainProductImg');
    if (mainImg) {
      // Добавляем обработчик события загрузки
      mainImg.addEventListener('load', function() {
        console.log('Main image loaded successfully');
      });
    }
  }
});
</script>
{% endblock %}
