{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container mx-auto px-4">
  <h1 class="text-2xl font-bold mb-6 text-center">–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤ Fruitsite</h1>
  
  <!-- –§–∏–ª—å—Ç—Ä—ã -->
  <div class="mb-6 bg-white p-4 rounded-lg shadow">
    <form method="GET" class="flex flex-wrap items-center gap-4">
      <div class="flex-1 min-w-64">
        <input type="text" name="search" value="{{ request.GET.search }}" 
               placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—é..." 
               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
      </div>
      <div>
        <select name="category" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
          <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
          {% for category in categories %}
            <option value="{{ category.id }}" {% if request.GET.category == category.id|slugify %}selected{% endif %}>
              {{ category.name }}
            </option>
          {% endfor %}
        </select>
      </div>
      <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition">
        –ü—Ä–∏–º–µ–Ω–∏—Ç—å
      </button>
    </form>
  </div>

  <!-- –¢–∞–±–ª–∏—Ü–∞ —Ç–æ–≤–∞—Ä–æ–≤ –≤ —Å—Ç–∏–ª–µ Excel -->
  <div class="bg-white rounded-lg shadow overflow-hidden">
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200">
              –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ü–∏–∏
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200">
              –û–±—ä–µ–º, –≥
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200">
              –í–∏–¥ —É–ø–∞–∫–æ–≤–∫–∏
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200">
              –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤ —É–ø–∞–∫–æ–≤–∫–µ
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200">
              –¶–µ–Ω–∞ –∑–∞ –µ–¥–∏–Ω–∏—Ü—É
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200">
              –¶–µ–Ω–∞ –∑–∞ —É–ø–∞–∫–æ–≤–∫—É
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-r border-gray-200">
              –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ
            </th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              –î–µ–π—Å—Ç–≤–∏–µ
            </th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          {% for product in products %}
          <tr class="hover:bg-gray-50 transition-colors">
            <td class="px-6 py-4 whitespace-nowrap border-r border-gray-200">
              <div class="flex items-center">
                <div class="flex-shrink-0 h-10 w-10 mr-3">
                  <div class="h-10 w-10 bg-green-100 rounded-full flex items-center justify-center">
                    <span class="text-sm font-semibold text-green-600">üçé</span>
                  </div>
                </div>
                <div>
                  <div class="text-sm font-medium text-gray-900">{{ product.name }}</div>
                  <div class="text-sm text-gray-500">{{ product.category.name|default:"–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏" }}</div>
                </div>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 border-r border-gray-200">
              {{ product.volume|default:"‚Äî" }}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 border-r border-gray-200">
              {{ product.package_type|default:"‚Äî" }}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 border-r border-gray-200">
              {{ product.quantity_in_package }}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 border-r border-gray-200">
              {% if product.price_per_unit > 0 %}
                {{ product.price_per_unit }} —Å–æ–º
              {% else %}
                {{ product.price }} —Å–æ–º
              {% endif %}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-blue-600 border-r border-gray-200">
              {% if product.price_per_package > 0 %}
                {{ product.price_per_package }} —Å–æ–º
              {% else %}
                {{ product.price }} —Å–æ–º
              {% endif %}
            </td>
            <td class="px-6 py-4 whitespace-nowrap border-r border-gray-200">
              <div class="flex items-center space-x-2 mb-2">
                <button type="button" onclick="decreaseQuantity({{ product.id }})" 
                        class="w-8 h-8 flex items-center justify-center bg-gray-100 hover:bg-gray-200 rounded-full text-gray-600 transition">
                  ‚àí
                </button>
                <input type="number" id="quantity-{{ product.id }}" min="1" max="{{ product.stock }}" value="1" 
                       class="w-16 text-center border border-gray-300 rounded px-2 py-1 text-sm">
                <button type="button" onclick="increaseQuantity({{ product.id }})" 
                        class="w-8 h-8 flex items-center justify-center bg-gray-100 hover:bg-gray-200 rounded-full text-gray-600 transition">
                  +
                </button>
              </div>
              <div class="mb-2">
                <select id="unit-type-{{ product.id }}" class="w-full text-xs border border-gray-300 rounded px-2 py-1" onchange="updatePrice({{ product.id }})">
                  <option value="unit">–ó–∞ –µ–¥–∏–Ω–∏—Ü—É ({{ product.price_per_unit|default:product.price }} —Å–æ–º)</option>
                  {% if product.price_per_package > 0 %}
                    <option value="package">–ó–∞ —É–ø–∞–∫–æ–≤–∫—É ({{ product.price_per_package }} —Å–æ–º)</option>
                  {% endif %}
                </select>
              </div>
              <div class="text-xs text-gray-500">
                –í –Ω–∞–ª–∏—á–∏–∏: {{ product.stock }}
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <button onclick="addToCart({{ product.id }})" 
                      class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium transition">
                –í –∫–æ—Ä–∑–∏–Ω—É
              </button>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="8" class="px-6 py-12 text-center text-gray-500">
              –¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  
  <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
  {% if products.has_other_pages %}
  <div class="mt-6 flex justify-center">
    <nav class="flex items-center space-x-2">
      {% if products.has_previous %}
        <a href="?page=1{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}" 
           class="px-3 py-2 bg-white border border-gray-300 rounded-md hover:bg-gray-50">–ü–µ—Ä–≤–∞—è</a>
        <a href="?page={{ products.previous_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}" 
           class="px-3 py-2 bg-white border border-gray-300 rounded-md hover:bg-gray-50">–ü—Ä–µ–¥—ã–¥—É—â–∞—è</a>
      {% endif %}
      
      <span class="px-3 py-2">
        –°—Ç—Ä–∞–Ω–∏—Ü–∞ {{ products.number }} –∏–∑ {{ products.paginator.num_pages }}
      </span>
      
      {% if products.has_next %}
        <a href="?page={{ products.next_page_number }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}" 
           class="px-3 py-2 bg-white border border-gray-300 rounded-md hover:bg-gray-50">–°–ª–µ–¥—É—é—â–∞—è</a>
        <a href="?page={{ products.paginator.num_pages }}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}{% if request.GET.category %}&category={{ request.GET.category }}{% endif %}" 
           class="px-3 py-2 bg-white border border-gray-300 rounded-md hover:bg-gray-50">–ü–æ—Å–ª–µ–¥–Ω—è—è</a>
      {% endif %}
    </nav>
  </div>
  {% endif %}
</div>

<!-- JavaScript –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É -->
<script>
function decreaseQuantity(productId) {
    const input = document.getElementById(`quantity-${productId}`);
    const currentValue = parseInt(input.value);
    if (currentValue > 1) {
        input.value = currentValue - 1;
    }
}

function increaseQuantity(productId) {
    const input = document.getElementById(`quantity-${productId}`);
    const currentValue = parseInt(input.value);
    const maxValue = parseInt(input.max);
    if (currentValue < maxValue) {
        input.value = currentValue + 1;
    }
}

function addToCart(productId) {
    const quantity = document.getElementById(`quantity-${productId}`).value;
    const unitType = document.getElementById(`unit-type-${productId}`).value;
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º AJAX-–∑–∞–ø—Ä–æ—Å –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É
    fetch("{% url 'cart:add_to_cart_ajax' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            'product_id': productId,
            'quantity': parseInt(quantity),
            'unit_type': unitType
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—à–Ω–æ–º –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏
            showNotification('–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É!', 'success');
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∫–æ—Ä–∑–∏–Ω—ã, –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
            updateCartCounter();
        } else {
            showNotification(data.message || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –≤ –∫–æ—Ä–∑–∏–Ω—É', 'error');
    });
}

function updatePrice(productId) {
    // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–∞–µ–º–æ–π —Ü–µ–Ω—ã –ø—Ä–∏ —Å–º–µ–Ω–µ –µ–¥–∏–Ω–∏—Ü—ã –∏–∑–º–µ—Ä–µ–Ω–∏—è
    // –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –≤–∏–∑—É–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
}

function showNotification(message, type) {
    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-4 py-2 rounded-md text-white z-50 transition-opacity ${
        type === 'success' ? 'bg-green-500' : 'bg-red-500'
    }`;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // –£–¥–∞–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
        notification.style.opacity = '0';
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, 3000);
}

function updateCartCounter() {
    // –ü–æ–ª—É—á–∞–µ–º –Ω–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∫–æ—Ä–∑–∏–Ω–µ —á–µ—Ä–µ–∑ AJAX
    fetch('/cart/count/', {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        const cartBadge = document.getElementById('cart-counter');
        if (cartBadge) {
            if (data.count > 0) {
                cartBadge.textContent = data.count;
                cartBadge.classList.remove('hidden');
            } else {
                cartBadge.classList.add('hidden');
            }
        }
    })
    .catch(error => {
        console.error('Error updating cart counter:', error);
    });
}
</script>

<!-- CSRF —Ç–æ–∫–µ–Ω –¥–ª—è AJAX-–∑–∞–ø—Ä–æ—Å–æ–≤ -->
{% csrf_token %}
{% endblock %}
